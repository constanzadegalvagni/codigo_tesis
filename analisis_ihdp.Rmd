---
title: "Análisis de dataset basado en IHDP"
author: "Constanza de Galvagni"
date: '2025'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE  
)
```

```{r warning = FALSE}
library(ggplot2)
library(patchwork)
library(ggdensity)
library(ggdist)
library(dplyr)
library(cowplot)
library(ggridges)
library(ggbeeswarm)
```

Creamos gráficos de ejemplo para ver los valores que toman las medias de las normales que usamos para generar las superficies A y B.

```{r}
pdf("../figuras/means_superficies.pdf", width = 8, height = 6)
x_grilla <- seq(-5,5,0.01)
y0_A = x_grilla
y1_A = x_grilla+4
plot(y0_A,type="l", xlab = "Grilla de valores", ylab = "Media")
lines(y1_A, col="red")
legend("bottomright", legend = c("mean(Y0), supA", "mean(Y1), supA"), col = c("black", "red"), pch = 18)

x_grilla <- seq(-5,5,0.01)
w = 0.5
beta=1
y0 = exp((x_grilla+w)*beta)
y1 = x_grilla *beta 
plot(y0,type="l", xlab = "Grilla de valores", ylab = "Media")
lines(y1, col = "red")
legend("topleft", legend = c("mean(Y0), supB", "mean(Y1), supB"), col = c("black", "red"), pch = 18)

x_grilla <- seq(-5,5,0.01)
w = 0.5
beta=1
y0 = exp((x_grilla+w)*beta)
y1 = x_grilla *beta 
plot(log(y0),type="l", xlab = "Grilla de valores", ylab = "log(Media)")
lines(log(y1), col = "red")
legend("topleft", legend = c("log(mean(Y0)), supB", "log(mean(Y1)), supB"), col = c("black", "red"), pch = 18)

dev.off()
```

Leemos los datos que generamos en el archivo de experimentacion_hill para analizar la performance de los modelos bajo esos datos

```{r}
res_sup_A <- read.csv('resultados/results_sup_A.csv')
res_sup_B <- read.csv('resultados/results_sup_B.csv')

if (!dir.exists("../figuras/resultados_ihdp")) {
  dir.create("../figuras/resultados_ihdp")
}

```

```{r}
df_error_ate_supA <- data.frame(
  error_ate = c(res_sup_A$BART.error_ate,
                res_sup_A$BCF.error_ate,
                res_sup_A$CF.error_ate),
  modelo = factor(rep(c("BART", "BCF", "CF"), each = nrow(res_sup_A)))
)
df_error_ate_supB <- data.frame(
  error_ate = c(res_sup_B$BART.error_ate,
                res_sup_B$BCF.error_ate,
                res_sup_B$CF.error_ate),
  modelo = factor(rep(c("BART", "BCF", "CF"), each = nrow(res_sup_B)))
)
```
```{r}
boxplot_error_supA <- ggplot(df_error_ate_supA, aes(x = modelo, y = error_ate, color = modelo)) +

  geom_quasirandom(width = 0.3, alpha = 0.4) +
    geom_boxplot(outlier.shape = NA, alpha = 0, color = "black") +
  theme_minimal()+
    guides(fill = "none") +
  labs(
    title = expression("Error " * widehat(ATE) * " para superficies de tipo A"),
    x = "Modelo",
    y = expression("Error " * widehat(ATE))
  ) +
theme_minimal(base_size = 12) +
  theme(legend.position = "none")


boxplot_error_supB <- ggplot(df_error_ate_supB, aes(x = modelo, y = error_ate, color = modelo)) +

  geom_quasirandom(width = 0.3, alpha = 0.4) +
    geom_boxplot(outlier.shape = NA, alpha = 0, color = "black") +
  coord_cartesian(ylim = c(NA, 0.7)) +
  theme_minimal()+
    guides(fill = "none") +
  labs(
    title = expression("Error " * widehat(ATE) * " para superficies de tipo B"),
    x = "Modelo",
    y = expression("Error " * widehat(ATE))
  ) +
theme_minimal(base_size = 12) +
  theme(legend.position = "none")


boxplot_error_supA
boxplot_error_supB

ggsave("../figuras/resultados_ihdp/error_atehat_supA.pdf", units = "in" , plot = ggdraw(boxplot_error_supA))
ggsave("../figuras/resultados_ihdp/error_atehat_supB.pdf", units = "in", plot = ggdraw(boxplot_error_supB))
```

```{r}
df_cate_rmse_supA <- data.frame(
  rmse = c(
    res_sup_A$BCF.rmse_cate_train, res_sup_A$CF.rmse_cate_train, res_sup_A$BART.rmse_cate_train,
    res_sup_A$BCF.rmse_cate_test,  res_sup_A$CF.rmse_cate_test,  res_sup_A$BART.rmse_cate_test
  ),
  modelo = factor(rep(c("BCF", "CF", "BART", "BCF", "CF", "BART"), each = nrow(res_sup_A))),
  split  = factor(rep(c("train", "train", "train", "test", "test", "test"), each = nrow(res_sup_A)))
)

plot_rmse_cate_supA <- ggplot(df_cate_rmse_supA, aes(x = modelo, y = rmse, fill = split)) +
  # boxplots separados para train y test

  # puntos distribuidos sin amontonarse
  geom_quasirandom(
    aes(color = split, group = interaction(modelo, split)),
    dodge.width = 0.8,
    size = 0.8,
    alpha = 0.5,
    shape = 1
  ) +
    geom_boxplot(
    aes(group = interaction(modelo, split)), 
    width = 0.3,
    position = position_dodge(width = 0.8),
    outlier.shape = NA,
    color = "black",
    fill = NA
  ) +
  labs(
    title = "RMSE(ITE) - Sup. A",
    x = "Modelo",
    y = "RMSE(ITE)",
    fill = "Conjunto",
    color = "Conjunto"
  ) +
scale_fill_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" )+
scale_color_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" ) +
    guides(color = guide_legend(
    override.aes=list(shape = 16, cex = 3))) +
  theme_minimal(base_size = 12)

plot_rmse_cate_supA
ggsave("../figuras/resultados_ihdp/rmse_cate_supA.pdf", units = "in" , plot = ggdraw(plot_rmse_cate_supA))
```
```{r}
df_cate_rmse_supB <- data.frame(
  rmse = c(
    res_sup_B$BCF.rmse_cate_train, res_sup_B$CF.rmse_cate_train, res_sup_B$BART.rmse_cate_train,
    res_sup_B$BCF.rmse_cate_test,  res_sup_B$CF.rmse_cate_test,  res_sup_B$BART.rmse_cate_test
  ),
  modelo = factor(rep(c("BCF", "CF", "BART", "BCF", "CF", "BART"), each = nrow(res_sup_B))),
  split  = factor(rep(c("train", "train", "train", "test", "test", "test"), each = nrow(res_sup_B)))
)

library(ggplot2)
library(ggbeeswarm)  # para geom_quasirandom

plot_rmse_cate_supB <- ggplot(df_cate_rmse_supB, aes(x = modelo, y = rmse, fill = split)) +
  # boxplots separados para train y test

  # puntos distribuidos sin amontonarse
  geom_quasirandom(
    aes(color = split, group = interaction(modelo, split)),
    dodge.width = 0.8,
    size = 0.8,
    alpha = 0.4,
    shape = 1
  ) +
    geom_boxplot(
    aes(group = interaction(modelo, split)), 
    width = 0.3,
    position = position_dodge(width = 0.8),
    outlier.shape = NA,
    color = "black",
    fill=NA
  ) +
  labs(
    title = "RMSE(ITE) - Sup. B",
    x = "Modelo",
    y = "RMSE(ITE)",
    fill = "Conjunto",
    color = "Conjunto"
  ) +
scale_fill_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" )+
scale_color_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" ) +
    guides(color = guide_legend(
    override.aes=list(shape = 16, cex = 3))) +
  theme_minimal(base_size = 12)

plot_rmse_cate_supB
ggsave("../figuras/resultados_ihdp/rmse_cate_supB.pdf", units = "in" , plot = ggdraw(plot_rmse_cate_supB))

```

```{r}
min(df_cate_rmse_supB$rmse)
min(df_cate_rmse_supA$rmse)
```

```{r}
len_datos <- dim(res_sup_A)[1]
```

```{r}

df_tam_ic_supA <- data.frame(
  valor = c(
    res_sup_A$BART.tam_medio_ic_cate_train,
    res_sup_A$BCF.tam_medio_ic_cate_train,
    res_sup_A$CF.tam_medio_ic_cate_train,
    res_sup_A$BART.tam_medio_ic_cate_test,
    res_sup_A$BCF.tam_medio_ic_cate_test,
    res_sup_A$CF.tam_medio_ic_cate_test
  ),
  modelo = rep(c("BART", "BCF", "CF", "BART", "BCF", "CF"), each = len_datos),
  conjunto = rep(c("train", "train", "train", "test", "test", "test"), each = len_datos)
)

df_tam_ic_supB <- data.frame(
  valor = c(
    res_sup_B$BART.tam_medio_ic_cate_train,
    res_sup_B$BCF.tam_medio_ic_cate_train,
    res_sup_B$CF.tam_medio_ic_cate_train,
    res_sup_B$BART.tam_medio_ic_cate_test,
    res_sup_B$BCF.tam_medio_ic_cate_test,
    res_sup_B$CF.tam_medio_ic_cate_test
  ),
  modelo = rep(c("BART", "BCF", "CF", "BART", "BCF", "CF"), each = len_datos),
  conjunto = rep(c("train", "train", "train", "test", "test", "test"), each = len_datos)
)


tam_ics_supA <- ggplot(df_tam_ic_supA, aes(x = modelo, y = valor, fill = conjunto)) +
  # boxplots separados para train y test

  # puntos distribuidos sin amontonarse
  geom_quasirandom(
    aes(color = conjunto, group = interaction(modelo, conjunto)),
    dodge.width = 0.8,
    size = 0.8,
    alpha = 0.4,
    shape = 1
  ) +
    geom_boxplot(
    aes(group = interaction(modelo, conjunto)), 
    width = 0.3,
    position = position_dodge(width = 0.8),
    outlier.shape = NA,
    color = "black",
    fill = NA
  ) +
  labs(
    title = "Tamaño medio ICs - Sup.A",
    x = "Modelo",
    y = "Tamaño IC",
    fill = "Conjunto",
    color = "Conjunto"
  ) +
scale_fill_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" )+
scale_color_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" ) +
    guides(color = guide_legend(
    override.aes=list(shape = 16, cex = 3))) +
  theme_minimal(base_size = 12)


tam_ics_supB <- ggplot(df_tam_ic_supB, aes(x = modelo, y = valor, fill = conjunto)) +
  # boxplots separados para train y test

  # puntos distribuidos sin amontonarse
  geom_quasirandom(
    aes(color = conjunto, group = interaction(modelo, conjunto)),
    dodge.width = 0.8,
    size = 0.8,
    alpha = 0.4,
    shape = 1
  ) +
    geom_boxplot(
    aes(group = interaction(modelo, conjunto)), 
    width = 0.3,
    position = position_dodge(width = 0.8),
    outlier.shape = NA,
    color = "black",
    fill = NA
  ) +
  labs(
    title = "Tamaño medio ICs - Sup. B",
    x = "Modelo",
    y = "Tamaño IC",
    fill = "Conjunto",
    color = "Conjunto"
  ) +
scale_fill_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" )+
scale_color_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" ) +
    guides(color = guide_legend(
    override.aes=list(shape = 16, cex = 3))) +
  theme_minimal(base_size = 12)

tam_ics_supA
ggsave("../figuras/resultados_ihdp/tam_ics_supA.pdf", units = "in" , plot = ggdraw(tam_ics_supA))
tam_ics_supB
ggsave("../figuras/resultados_ihdp/tam_ics_supB.pdf", units = "in" , plot = ggdraw(tam_ics_supB))

```

```{r}
df_cov_cate_supA <- data.frame(
  coverage = c(
    res_sup_A$BART.coverage_cate_train,
    res_sup_A$BART.coverage_cate_test,
    res_sup_A$BCF.coverage_cate_train,
    res_sup_A$BCF.coverage_cate_test,
    res_sup_A$CF.coverage_cate_train,
    res_sup_A$CF.coverage_cate_test
  ),
  modelo = factor(rep(c("BART", "BART", "BCF", "BCF", "CF", "CF"),
                      each = nrow(res_sup_A))),
  conjunto = factor(rep(c("train", "test", "train", "test", "train", "test"),
                        each = nrow(res_sup_A)))
)

df_cov_cate_supB <- data.frame(
  coverage = c(
    res_sup_B$BART.coverage_cate_train,
    res_sup_B$BART.coverage_cate_test,
    res_sup_B$BCF.coverage_cate_train,
    res_sup_B$BCF.coverage_cate_test,
    res_sup_B$CF.coverage_cate_train,
    res_sup_B$CF.coverage_cate_test
  ),
  modelo = factor(rep(c("BART", "BART", "BCF", "BCF", "CF", "CF"),
                      each = nrow(res_sup_B))),
  conjunto = factor(rep(c("train", "test", "train", "test", "train", "test"),
                        each = nrow(res_sup_B)))
)


cov_cate_supA <- ggplot(df_cov_cate_supA, aes(x = modelo, y = coverage, fill = conjunto)) +
  # boxplots separados para train y test

  # puntos distribuidos sin amontonarse
  geom_quasirandom(
    aes(color = conjunto, group = interaction(modelo, conjunto)),
    dodge.width = 0.8,
    size = 0.8,
    alpha = 0.4,
    shape = 1
  ) +
    geom_boxplot(
    aes(group = interaction(modelo, conjunto)), 
    width = 0.3,
    position = position_dodge(width = 0.8),
    outlier.shape = NA,
    color = "black",
    fill = NA
  ) +
    geom_hline(yintercept = 0.95, linetype = "dashed", color = "orange", linewidth = 0.6) +  # línea en y=0.95
  labs(
    title = "Coverage ITE - Sup. A",
    x = "Modelo",
    y = "Tamaño IC",
    fill = "Conjunto",
    color = "Conjunto"
  ) +
scale_fill_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" )+
scale_color_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" ) +
    guides(color = guide_legend(
    override.aes=list(shape = 16, cex = 3))) +
  theme_minimal(base_size = 12)


cov_cate_supB <- ggplot(df_cov_cate_supB, aes(x = modelo, y = coverage, fill = conjunto)) +
  # boxplots separados para train y test

  # puntos distribuidos sin amontonarse
  geom_quasirandom(
    aes(color = conjunto, group = interaction(modelo, conjunto)),
    dodge.width = 0.8,
    size = 0.8,
    alpha = 0.4,
    shape = 1
  ) +
    geom_boxplot(
    aes(group = interaction(modelo, conjunto)), 
    width = 0.3,
    position = position_dodge(width = 0.8),
    outlier.shape = NA,
    color = "black",
    fill = NA
  ) +
    geom_hline(yintercept = 0.95, linetype = "dashed", color = "orange", linewidth = 0.6) +  # línea en y=0.95
  labs(
    title = "Coverage ITE - Sup. B",
    x = "Modelo",
    y = "Tamaño IC",
    fill = "Conjunto",
    color = "Conjunto"
  ) +
scale_fill_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" )+
scale_color_manual(   values = c("test" = "#1F7835",              "train" = "#762A83"),   name = "Conjunto" ) +
    guides(color = guide_legend(
    override.aes=list(shape = 16, cex = 3))) +
  theme_minimal(base_size = 12)

cov_cate_supA
cov_cate_supB

ggsave("../figuras/resultados_ihdp/cov_cate_supA.pdf", units = "in" , plot = ggdraw(cov_cate_supA))
ggsave("../figuras/resultados_ihdp/cov_cate_supB.pdf", units = "in" , plot = ggdraw(cov_cate_supB))
```

```{r}
data_gelman <- data.frame(
  dataset = rep(1:len_datos, times = 2),
  superficie = rep(c("Superficies A", "Superficies B"), each = len_datos),
  gelman = c(res_sup_A$BART.gelman, res_sup_B$BART.gelman)
)

colores <- c(
  "Superficies A" = "#FF4081",    
  "Superficies B" = "orange"     
)


gelman_bart <- ggplot(data_gelman, aes(x = superficie, y = gelman, fill = superficie, color = superficie)) +
  # boxplots separados para train y test

  # puntos distribuidos sin amontonarse
  geom_quasirandom(
    aes(color = superficie),
    dodge.width = 0.8,
    size = 0.8,
    alpha = 1,
    shape = 1
  ) +
    geom_boxplot(
    aes(group = superficie), 
    width = 0.3,
    position = position_dodge(width = 0.8),
    outlier.shape = NA,
    color = "black",
    fill = NA
  ) +
  labs(
    title = "Métrica de Gelman-Rubin para BART",
    x = "Superficie",
    y = "Diagnóstico de Gelman-Rubin",
    fill = "Superficie",
    color = "Superficie"
  ) +
scale_fill_manual(   values = colores,   name = "Superficie" )+
scale_color_manual(   values = colores,   name = "Superficie" ) +
    guides(color = guide_legend(
    override.aes=list(shape = 16, cex = 3))) +
  theme_minimal(base_size = 12)+
  labs(x = NULL) +          # quita el título del eje x
  theme(legend.position = "none")   # elimina la leyenda
gelman_bart
ggsave("../figuras/resultados_ihdp/gelman_bart.pdf", units = "in" , plot = ggdraw(gelman_bart))
```

```{r}
data_autocorr <- data.frame(
  dataset = rep(1:len_datos, times = 2),
  superficie = rep(c("Superficies A", "Superficies B"), each = len_datos),
  autocorr = c(res_sup_A$BCF.autocorr, res_sup_B$BCF.autocorr)
)
colores <- c(
  "Superficies A" = "#FF4081",    
  "Superficies B" = "orange"     
)

autocorr_bcf <- ggplot(data_autocorr, aes(x = superficie, y = autocorr, fill = superficie, color = superficie)) +
  # boxplots separados para train y test

  # puntos distribuidos sin amontonarse
  geom_quasirandom(
    aes(color = superficie),
    dodge.width = 0.8,
    size = 0.8,
    alpha = 1,
    shape = 1
  ) +
    geom_boxplot(
    aes(group = superficie), 
    width = 0.3,
    position = position_dodge(width = 0.8),
    outlier.shape = NA,
    color = "black",
    fill = NA
  ) +
  labs(
    title = "Autocorrelación para cadenas de BCF",
    x = "Superficie",
    y = "Autocorrelación",
    fill = "Superficie",
    color = "Superficie"
  ) +
scale_fill_manual(   values = colores,   name = "Superficie" )+
scale_color_manual(   values = colores,   name = "Superficie" ) +
    guides(color = guide_legend(
    override.aes=list(shape = 16, cex = 3))) +
  theme_minimal(base_size = 12) +
  labs(x = NULL) +          # quita el título del eje x
  theme(legend.position = "none")   # elimina la leyenda

autocorr_bcf
ggsave("../figuras/resultados_ihdp/autocorr_bcf.pdf", units = "in" , plot = ggdraw(autocorr_bcf))
```

```{r}
sups <- c("A", "B")
cjto <- c("train", "test")
mod <- c("BART", "BCF", "CF")

nombres_cates <- list()
titulos_plots <- list()
df_por_sup <- list()

for (sup in sups){
  df_list <- list()
  for (cj in cjto){
    for (m in mod){
      var <- paste0("cate_sup",sup,"_",cj,"_",m)
      df <- read.csv(paste0("resultados_sup_aleatoria/", var, ".csv"))
      assign(var, df)
      nombres_cates <- append(nombres_cates, var)
      titulos_plots <- append(titulos_plots, m)
      df_list <- append(df_list, list(df))
    }
  }
  df_por_sup[[sup]] <- bind_rows(df_list)
}

```

```{r}
ylim_supA <- range(df_por_sup[["A"]]$CATE_estimado, na.rm = TRUE)
#ylim_supA <- c(ylim_supA[1]-0.5, ylim_supA[2]+0.5)
ylim_supB <- range(df_por_sup[["B"]]$CATE_estimado, na.rm = TRUE)
#ylim_supB <- c(ylim_supB[1]-0.5, ylim_supB[2]+0.5)
```

```{r}
ylim_supA
ylim_supB
```

```{r}
plot_real_vs_est <- function(df, titulo, ylim = NULL){
  df$cubre <- as.factor(df$cubre)
  
  p <- ggplot(df, aes(x = CATE_real, y = CATE_estimado, color = cubre)) +
    geom_point(alpha = 0.6, size = 2, shape = 1) +
    geom_abline(intercept = 0, slope = 1, color = "firebrick1") +
    geom_hline(yintercept = 4, color = "springgreen2", linetype = "11", size = 1) +
    labs(
      x = "ITE",
      y = expression(widehat(CATE)),
      title = titulo
    ) +
    scale_color_manual(values = c("1" = "deepskyblue", "0" = "hotpink")) +
    theme_minimal() +
    guides(color = "none")
  
  if (!is.null(ylim)) {
    p <- p + coord_cartesian(ylim = ylim)
  }
  
  
  return(p)
}



```

```{r}
graficos_catevsest <- list()
for (i in 1:length(nombres_cates)){
  df <- get(nombres_cates[[i]])# recupera el dataframe por su nombre
  if (grepl("supA", nombres_cates[[i]], fixed = TRUE)){
    ylim_func <- ylim_supA
  } else{
    ylim_func <- ylim_supB
  }
  p <- plot_real_vs_est(df, titulos_plots[[i]], ylim_func) # genera el plot
  # print(p)                       # muestra el plot
  graficos_catevsest[[i]] <- p
}
```

```{r}
library(patchwork)
catevsest_supA_train <- graficos_catevsest[[1]] + graficos_catevsest[[2]] + graficos_catevsest[[3]] #+plot_annotation(title = "Conjunto Train - Sup. A")
catevsest_supA_test <- graficos_catevsest[[4]] + graficos_catevsest[[5]] + graficos_catevsest[[6]] #+plot_annotation(title = "Conjunto Test - Sup. A")

catevsest_supB_train <- graficos_catevsest[[7]] + graficos_catevsest[[8]] + graficos_catevsest[[9]] #+plot_annotation(title = "Conjunto Train - Sup. B")
catevsest_supB_test <- graficos_catevsest[[10]] + graficos_catevsest[[11]] + graficos_catevsest[[12]] #+plot_annotation(title = "Conjunto Test - Sup. B")

catevsest_supA_train
catevsest_supA_test
catevsest_supB_train
catevsest_supB_test

ggsave("../figuras/resultados_ihdp/catevsest_supA_train.pdf", units = "in" , plot = catevsest_supA_train)
ggsave("../figuras/resultados_ihdp/catevsest_supB_train.pdf", units = "in" , plot = catevsest_supB_train)
ggsave("../figuras/resultados_ihdp/catevsest_supA_test.pdf", units = "in" , plot = catevsest_supA_test)
ggsave("../figuras/resultados_ihdp/catevsest_supB_test.pdf", units = "in" , plot = catevsest_supB_test)
```
```{r}
sapply(graficos_catevsest, function(p) p$labels$title)
```

